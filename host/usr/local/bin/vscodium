#!/bin/bash

# Exit immediately if a command fails, treat unset variables as errors, and
# propagate errors through pipes
set -eou pipefail

################################################################################
# Variable declaration, initialization, and script sourcing
################################################################################

# Absolute path of the script
declare script_dir
# shellcheck source=../share/vscodium-container/functions/share.sh
script_dir=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd )
# Source share.sh
. "${script_dir}/../share/vscodium-container/functions/share.sh"

# Define an app name (currently set obtained from the script name)
declare app
app="$(basename "$0")"

# Container image to run
declare image="localhost/vscodium:latest"

# Container home directory (mounted inside container)
# Kept in the host's home for easy access
declare app_persistent_home="${HOME}/.var/podman/${app}"

# Podman global default args (applied to all Podman commands)
declare -a podman_global_default_args=(

)
# Podman global custom args (applied to all Podman commands)
declare -a podman_global_custom_args=(

)
# Podman run command default args
declare -a podman_run_default_args=(
    # Remove container after exit
    --rm
    # Keep STDIN open
    --interactive
    # Allocate a pseudo-TTY
    --tty
    # Run as current host user
    --user="$(id -u):$(id -g)"
    # Keep user namespace ID
    --userns=keep-id
    # Keep supplementary groups
    --group-add=keep-groups
    # Disable SELinux labeling
    --security-opt=label=disable
    # Remove /dev/shm size limit
    --shm-size=0
)
# Podman run command custom args
declare -a podman_run_custom_args=(

)

# Application-specific default arguments
declare -a app_default_args=(
    # Force VSCodium to use Wayland
    --ozone-platform=wayland
)
# Application-specific custom arguments
declare -a app_custom_args=(
    # Add any project-specific VSCodium args here
)

# Final assembled Podman command
declare -a cmd

################################################################################
# Execution
################################################################################


# Share environment and host resources
share-host-env
share-host-home-rw
share-app-home
share-gitconfig
share-ssh
share-system-dbus-socket
share-session-dbus-socket
share-wayland-socket
share-x11
share-gpu

# Command assembly
cmd=(
    podman
    "${podman_global_default_args[@]}"
    "${podman_global_custom_args[@]}"
    run
    "${podman_run_default_args[@]}"
    "${podman_run_custom_args[@]}"
    "$image"
    "${app_default_args[@]}"
    "${app_custom_args[@]}"
    # Pass any additional CLI arguments to container
    "$@"
)

# Print command for debugging
echo "${cmd[@]@Q}"

# Execute the full command
exec "${cmd[@]}"
